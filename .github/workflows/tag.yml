name: Creates a tag when closing the stable milestone
on:
  milestone:
    types: [closed]
jobs:
    create_tag:
        name: Creates a tag when the stable branch milestone is closed
        runs-on: ubuntu-latest
        steps:
          - name: Filter milestone by name
            run: |
              echo "RELEASE_MILESTONE=$(echo ${{ github.event.milestone.title }} | grep -P '^s\K[0-9]+\.[0-9]+\.[0-9]+' | sed 's/s//')" >> $GITHUB_ENV
          - name: Print milestone version
            run: |
              echo "stable milestone release: $RELEASE_MILESTONE"
          - name: Fetch full history and checkout stable branch
            uses: actions/checkout@v2
            with:
              ref: stable/${{ env.RELEASE_MILESTONE }}
              fetch-depth: 0
            if: "env.RELEASE_MILESTONE"
          - name: Creates a tag from stable branch
            id: tag_version
            uses: mathieudutour/github-tag-action@v5.5
            with:
              github_token: ${{ secrets.GITHUB_TOKEN }}
              custom_tag: ${{ env.RELEASE_MILESTONE }}
            if: "env.RELEASE_MILESTONE"
          - name: Create github release for tag
            uses: ncipollo/release-action@v1
            with:
              tag: ${{ steps.tag_version.outputs.new_tag }}
              name: Release ${{ steps.tag_version.outputs.new_tag }}
              body: ${{ steps.tag_version.outputs.changelog }}
              token: ${{ secrets.GITHUB_TOKEN }}
            if: "env.RELEASE_MILESTONE"
          - name: Expose git commit data
            uses: rlespinasse/git-commit-data-action@v1.x
          - name: Create PR to master based on current version
            id: cpr
            uses: peter-evans/create-pull-request@v3
            with:
              commit-message: [create-pull-request] Merge release ${{ env.RELEASE_MILESTONE }}
              committer: ${{ env.GIT_COMMIT_COMMITTER }}
              signoff: true
              branch: stable/${{ env.RELEASE_MILESTONE }}
              delete-branch: true
              base: master
              title: Release ${{ steps.tag_version.outputs.new_tag }} merge to master
              body: ${{ steps.tag_version.outputs.changelog }}
              labels: release,critical
              reviewers: orviz,samuelbernardolip,davrodgon
              token: ${{ secrets.GITHUB_TOKEN }}
            if: "env.RELEASE_MILESTONE"
          - name: Check PR details
            if: "env.RELEASE_MILESTONE"
            run: |
              echo "Pull Request Number - ${{ steps.cpr.outputs.pull-request-number }}"
              echo "Pull Request URL - ${{ steps.cpr.outputs.pull-request-url }}"
